apiVersion: 1

groups:
  # =========================================================================
  # Infrastructure — 인프라 장애 감지
  # =========================================================================
  - orgId: 1
    name: Infrastructure
    folder: Infrastructure
    interval: 1m
    rules:
      # --- Service Down (critical) ---
      - uid: service_down
        title: Service Down
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: up == 0
              instant: true
              refId: A
          - refId: C
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params: [0]
              refId: C
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "{{ $labels.job }}/{{ $labels.instance }} is down"
          dashboard_url: "/d/infrastructure"
        noDataState: OK
        execErrState: Alerting

      # --- Probe Failure (critical) ---
      - uid: probe_failure
        title: Probe Failure
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: probe_success == 0
              instant: true
              refId: A
          - refId: C
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params: [0]
              refId: C
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Probe failed for {{ $labels.instance }}"
          dashboard_url: "/d/infrastructure"
        noDataState: OK
        execErrState: Alerting

      # --- Error Rate > 50% (critical) ---
      - uid: error_rate_critical
        title: "Error Rate > 50%"
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: |
                (
                  sum by (instance) (rate(http_server_requests_seconds_count{status=~"5.."}[5m]))
                  /
                  sum by (instance) (rate(http_server_requests_seconds_count[5m]))
                ) > 0.5
              instant: true
              refId: A
          - refId: C
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params: [0]
              refId: C
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Error rate exceeds 50% on {{ $labels.instance }}"
          dashboard_url: "/d/application"
        noDataState: OK
        execErrState: Alerting

      # --- Disk > 95% (critical) ---
      - uid: disk_critical
        title: "Disk > 95%"
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: |
                (
                  node_filesystem_avail_bytes{fstype!~"tmpfs|overlay"}
                  /
                  node_filesystem_size_bytes{fstype!~"tmpfs|overlay"}
                ) < 0.05
              instant: true
              refId: A
          - refId: C
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params: [0]
              refId: C
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Disk usage > 95% on {{ $labels.instance }} ({{ $labels.mountpoint }})"
          dashboard_url: "/d/infrastructure"
        noDataState: OK
        execErrState: Alerting

      # --- Memory > 90% (high) ---
      - uid: memory_high
        title: "Memory > 90%"
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: |
                (
                  1 - node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes
                ) > 0.9
              instant: true
              refId: A
          - refId: C
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params: [0]
              refId: C
        for: 5m
        labels:
          severity: high
        annotations:
          summary: "Memory usage > 90% on {{ $labels.instance }}"
          dashboard_url: "/d/infrastructure"
        noDataState: OK
        execErrState: Alerting

      # --- CPU > 80% (warning) ---
      - uid: cpu_high
        title: "CPU > 80%"
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: |
                (
                  1 - avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m]))
                ) > 0.8
              instant: true
              refId: A
          - refId: C
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params: [0]
              refId: C
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "CPU usage > 80% on {{ $labels.instance }}"
          dashboard_url: "/d/infrastructure"
        noDataState: OK
        execErrState: Alerting

      # --- Disk > 80% (warning) ---
      - uid: disk_warning
        title: "Disk > 80%"
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: |
                (
                  node_filesystem_avail_bytes{fstype!~"tmpfs|overlay"}
                  /
                  node_filesystem_size_bytes{fstype!~"tmpfs|overlay"}
                ) < 0.2
              instant: true
              refId: A
          - refId: C
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params: [0]
              refId: C
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Disk usage > 80% on {{ $labels.instance }} ({{ $labels.mountpoint }})"
          dashboard_url: "/d/infrastructure"
        noDataState: OK
        execErrState: Alerting

  # =========================================================================
  # Application — 앱 레벨 이상 감지
  # =========================================================================
  - orgId: 1
    name: Application
    folder: Application
    interval: 1m
    rules:
      # --- Error Rate > 10% (high) ---
      - uid: error_rate_high
        title: "Error Rate > 10%"
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: |
                (
                  sum by (application, instance) (rate(http_server_requests_seconds_count{status=~"5.."}[5m]))
                  /
                  sum by (application, instance) (rate(http_server_requests_seconds_count[5m]))
                ) > 0.1
              instant: true
              refId: A
          - refId: C
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params: [0]
              refId: C
        for: 3m
        labels:
          severity: high
        annotations:
          summary: "Error rate > 10% on {{ $labels.application }}({{ $labels.instance }})"
          dashboard_url: "/d/application"
        noDataState: OK
        execErrState: Alerting

      # --- p99 > 5s (high) ---
      - uid: p99_high
        title: "p99 Latency > 5s"
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: |
                histogram_quantile(0.99,
                  sum by (le, application, instance) (
                    rate(http_server_requests_seconds_bucket[5m])
                  )
                ) > 5
              instant: true
              refId: A
          - refId: C
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params: [0]
              refId: C
        for: 3m
        labels:
          severity: high
        annotations:
          summary: "p99 latency > 5s on {{ $labels.application }}({{ $labels.instance }})"
          dashboard_url: "/d/application"
        noDataState: OK
        execErrState: Alerting

      # --- HikariCP Pending > 0 (high) ---
      - uid: hikari_pending
        title: HikariCP Pending Connections
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: hikaricp_connections_pending > 0
              instant: true
              refId: A
          - refId: C
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params: [0]
              refId: C
        for: 2m
        labels:
          severity: high
        annotations:
          summary: "HikariCP has pending connections on {{ $labels.application }}({{ $labels.instance }})"
          dashboard_url: "/d/application"
        noDataState: OK
        execErrState: Alerting

      # --- GC Pause > 500ms (warning) ---
      - uid: gc_pause_high
        title: "GC Pause > 500ms"
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: jvm_gc_pause_seconds_max > 0.5
              instant: true
              refId: A
          - refId: C
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params: [0]
              refId: C
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "GC pause > 500ms on {{ $labels.application }}({{ $labels.instance }})"
          dashboard_url: "/d/application"
        noDataState: OK
        execErrState: Alerting

  # =========================================================================
  # Info — 참고용 알림
  # =========================================================================
  - orgId: 1
    name: Info
    folder: Info
    interval: 1m
    rules:
      # --- Service Restarted (info) ---
      - uid: service_restarted
        title: Service Restarted
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              expr: changes(process_start_time_seconds[5m]) > 0
              instant: true
              refId: A
          - refId: C
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              type: threshold
              expression: A
              conditions:
                - evaluator:
                    type: gt
                    params: [0]
              refId: C
        for: 0s
        labels:
          severity: info
        annotations:
          summary: "{{ $labels.job }}/{{ $labels.instance }} has restarted"
        noDataState: OK
        execErrState: OK