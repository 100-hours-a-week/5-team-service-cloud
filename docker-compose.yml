services:
  mysql:
    image: mysql:8.0.44
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_DATABASE: doktoridb
    ports:
      - "3307:3306"
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - db-net
    healthcheck:
      test: ["CMD-SHELL", "mysql -u root -p$$MYSQL_ROOT_PASSWORD -e 'SELECT 1' 2>/dev/null"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 30s
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  redis:
    image: redis:7-alpine
    command: redis-server --maxmemory 128mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - db-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  backend:
    build:
      context: ./Backend
      target: api
    env_file: ./Backend/.env
    environment:
      DB_URL: "jdbc:mysql://mysql:3306/doktoridb?serverTimezone=Asia/Seoul&useSSL=false&allowPublicKeyRetrieval=true"
      SPRING_DATASOURCE_URL: "jdbc:mysql://mysql:3306/doktoridb?serverTimezone=Asia/Seoul&useSSL=false&allowPublicKeyRetrieval=true"
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      AI_BASE_URL: "http://ai:8000/ai"
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379
    networks:
      - app-net
      - db-net
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8080/api/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
    stop_grace_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  chat:
    build:
      context: ./Backend
      target: chat
    env_file: ./Backend/.env
    environment:
      DB_URL: "jdbc:mysql://mysql:3306/doktoridb?serverTimezone=Asia/Seoul&useSSL=false&allowPublicKeyRetrieval=true"
      SPRING_DATASOURCE_URL: "jdbc:mysql://mysql:3306/doktoridb?serverTimezone=Asia/Seoul&useSSL=false&allowPublicKeyRetrieval=true"
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379
    networks:
      - app-net
      - db-net
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8081/api/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 40s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
    stop_grace_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  ai:
    build:
      context: ./AI
      args:
        PYTHON_VERSION: "3.10"
    env_file: ./AI/.env
    environment:
      SPRING_BASE_URL: "http://backend:8080/api"
      DATABASE_URL: "mysql+pymysql://${DB_USERNAME}:${DB_PASSWORD}@mysql:3306/doktoridb"
    networks:
      - app-net
      - db-net
    depends_on:
      mysql:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8000/health')"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.5'
    stop_grace_period: 15s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  frontend:
    build:
      context: ./Frontend
      args:
        NEXT_PUBLIC_API_BASE_URL: ""
    volumes:
      - frontend-static:/app/.next/static
      - frontend-public:/app/public
    networks:
      - app-net
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  nginx:
    image: nginx:1.27-alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx/docker/nginx.conf:/etc/nginx/nginx.conf:ro
      - frontend-static:/usr/share/nginx/_next/static:ro
      - frontend-public:/usr/share/nginx/public:ro
    networks:
      - app-net
    depends_on:
      frontend:
        condition: service_started
      backend:
        condition: service_healthy
      chat:
        condition: service_healthy
      ai:
        condition: service_healthy
    restart: unless-stopped
    stop_grace_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  app-net:
    driver: bridge
  db-net:
    driver: bridge

volumes:
  mysql-data:
  redis-data:
  frontend-static:
  frontend-public: