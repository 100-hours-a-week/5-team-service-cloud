name: Monitoring CD

on:
  push:
    branches: [main]
    paths:
      - 'monitoring/**'

concurrency:
  group: monitoring-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed files
        id: changes
        run: |
          CHANGED=$(git diff --name-only HEAD~1 HEAD -- monitoring/)
          echo "changed<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "compose=false" >> $GITHUB_OUTPUT
          echo "prometheus=false" >> $GITHUB_OUTPUT
          echo "loki=false" >> $GITHUB_OUTPUT
          echo "grafana_alerting=false" >> $GITHUB_OUTPUT
          echo "grafana_dashboards=false" >> $GITHUB_OUTPUT

          if echo "$CHANGED" | grep -q "^monitoring/docker-compose.yml"; then
            echo "compose=true" >> $GITHUB_OUTPUT
          fi
          if echo "$CHANGED" | grep -q "^monitoring/prometheus/"; then
            echo "prometheus=true" >> $GITHUB_OUTPUT
          fi
          if echo "$CHANGED" | grep -q "^monitoring/loki/"; then
            echo "loki=true" >> $GITHUB_OUTPUT
          fi
          if echo "$CHANGED" | grep -q "^monitoring/grafana/provisioning/alerting/"; then
            echo "grafana_alerting=true" >> $GITHUB_OUTPUT
          fi
          if echo "$CHANGED" | grep -q "^monitoring/grafana/dashboards/"; then
            echo "grafana_dashboards=true" >> $GITHUB_OUTPUT
          fi

          echo "::group::Changed files"
          echo "$CHANGED"
          echo "::endgroup::"

      - name: Transfer files to monitoring server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.MONITORING_EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.MONITORING_SSH_KEY }}
          source: "monitoring/"
          target: "/home/ubuntu/"
          overwrite: true

      - name: Conditional service restart
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.MONITORING_EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.MONITORING_SSH_KEY }}
          script: |
            set -e
            cd /home/ubuntu/monitoring

            COMPOSE_CHANGED="${{ steps.changes.outputs.compose }}"
            PROMETHEUS_CHANGED="${{ steps.changes.outputs.prometheus }}"
            LOKI_CHANGED="${{ steps.changes.outputs.loki }}"
            ALERTING_CHANGED="${{ steps.changes.outputs.grafana_alerting }}"
            DASHBOARDS_CHANGED="${{ steps.changes.outputs.grafana_dashboards }}"

            if [ "$COMPOSE_CHANGED" = "true" ]; then
              echo "ğŸ”„ docker-compose.yml changed â€” recreating services..."
              docker compose up -d
            else
              if [ "$PROMETHEUS_CHANGED" = "true" ]; then
                echo "ğŸ”„ Prometheus config changed â€” hot reloading..."
                curl -sf -X POST http://localhost:9090/-/reload
                echo " âœ… Prometheus reloaded"
              fi

              if [ "$LOKI_CHANGED" = "true" ]; then
                echo "ğŸ”„ Loki config changed â€” restarting..."
                docker compose restart loki
              fi

              if [ "$ALERTING_CHANGED" = "true" ]; then
                echo "ğŸ”„ Grafana alerting changed â€” restarting..."
                docker compose restart grafana
              fi

              if [ "$DASHBOARDS_CHANGED" = "true" ]; then
                echo "ğŸ“Š Grafana dashboards updated â€” auto-reload in ~30s (no restart needed)"
              fi
            fi

            echo "âœ… Monitoring deployment complete"

      - name: Notify Discord
        if: always()
        run: |
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          COMMIT_MSG=$(echo '${{ github.event.head_commit.message }}' | head -1)
          COMMIT_AUTHOR="${{ github.event.head_commit.author.name }}"
          COMMIT_URL="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
          ACTIONS_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          if [ "${{ job.status }}" == "success" ]; then
            COLOR=3066993; STATUS_EMOJI="âœ…"; STATUS_TEXT="ë°°í¬ ì„±ê³µ"
          else
            COLOR=15158528; STATUS_EMOJI="âŒ"; STATUS_TEXT="ë°°í¬ ì‹¤íŒ¨"
          fi

          CHANGED_SUMMARY=$(echo '${{ steps.changes.outputs.changed }}' | head -5)
          if [ $(echo '${{ steps.changes.outputs.changed }}' | wc -l) -gt 5 ]; then
            CHANGED_SUMMARY="${CHANGED_SUMMARY}\n... and more"
          fi

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{
                 \"content\": \"$STATUS_EMOJI **Monitoring ë°°í¬ ì•Œë¦¼**\",
                 \"embeds\": [{
                   \"title\": \"ğŸ“¡ [Monitoring] $STATUS_TEXT\",
                   \"color\": $COLOR,
                   \"fields\": [
                     {\"name\": \"ğŸ“¦ ì €ì¥ì†Œ\", \"value\": \"\`${{ github.repository }}\`\", \"inline\": true},
                     {\"name\": \"ğŸŒ¿ ë¸Œëœì¹˜\", \"value\": \"\`${{ github.ref_name }}\`\", \"inline\": true},
                     {\"name\": \"ğŸ”– ì»¤ë°‹\", \"value\": \"[\`$SHORT_SHA\`]($COMMIT_URL)\", \"inline\": true},
                     {\"name\": \"ğŸ’¬ ì»¤ë°‹ ë©”ì‹œì§€\", \"value\": \"$COMMIT_MSG\", \"inline\": false},
                     {\"name\": \"ğŸ‘¤ ì‘ì„±ì\", \"value\": \"$COMMIT_AUTHOR\", \"inline\": true},
                     {\"name\": \"ğŸ“‹ ìƒì„¸ ë¡œê·¸\", \"value\": \"[Actionsì—ì„œ í™•ì¸]($ACTIONS_URL)\", \"inline\": true},
                     {\"name\": \"ğŸ“‚ ë³€ê²½ íŒŒì¼\", \"value\": \"\`\`\`$CHANGED_SUMMARY\`\`\`\", \"inline\": false}
                   ],
                   \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
                 }]
               }" \
               ${{ secrets.DISCORD_WEBHOOK_URL }} || true
