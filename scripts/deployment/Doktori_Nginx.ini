# /etc/systemd/system/nginx.service
[Unit]
Description=Nginx HTTP Server and Reverse Proxy
Documentation=https://nginx.org/en/docs/
After=network-online.target remote-fs.target nss-lookup.target
Wants=network-online.target

[Service]
Type=forking
PIDFile=/run/nginx.pid

# 시작 전 설정 파일 검증
ExecStartPre=/usr/sbin/nginx -t -q -g 'daemon on; master_process on;'
ExecStart=/usr/sbin/nginx -g 'daemon on; master_process on;'

# Graceful reload (설정 변경 시)
ExecReload=/bin/sh -c "/bin/kill -s HUP $(/bin/cat /run/nginx.pid)"

# Graceful stop
ExecStop=/bin/sh -c "/bin/kill -s QUIT $(/bin/cat /run/nginx.pid)"

# 강제 종료 시 타임아웃
TimeoutStopSec=30
KillMode=mixed

# 실패 시 자동 재시작
Restart=on-failure
RestartSec=10s

# 보안 설정
NoNewPrivileges=true
PrivateTmp=true

# 리소스 제한
LimitNOFILE=65536
LimitNPROC=512

[Install]
WantedBy=multi-user.target